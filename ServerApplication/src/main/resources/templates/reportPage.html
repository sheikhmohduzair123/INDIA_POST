<!-- header -->
<th:block th:include="_header"></th:block>
<!-- /header -->

<div class="fixed-header container-sm-footer">
    <div class="site-wrapper market-US">

        <form name="reportForm" id="reportForm" autocomplete="off">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <strong>
                <h1 class="text-center" th:text="#{parcel.report}">Parcel Report</h1></strong>
            <div class="col-md-12">

                <div class="col-md-offset-2 col-md-3 spacer-bootom-sm">
                    <div class="form-group">
                        <label th:text="#{from.date}">From Date </label>

                        <input name="fromdate" id="fromdate" class="form-control name" autocomplete="off" type="date" data-toggle="tooltip">
                    </div>

                </div>

                <div class="col-md-3">
                    <div class="form-group">
                        <label th:text="#{to.date}">To Date </label>

                        <input name="todate" id="todate" autocomplete="off" class="form-control name" type="date" data-toggle="tooltip">
                    </div>

                </div>

                <div class="col-md-2 spacer-top-md">
                    <button type="button" id="submitGetReport" class="btn btn-primary form-control" th:text="#{get.report}">
                        Get Report
                    </button>
                </div>

                <!--Download Section-->

            </div>
        </form>
        <div class="col-md-12 downloadReport" style="display:none">
            <div class="col-md-offset-9 col-md-3 spacer-bootom-sm">
                <div class="col-md-8">
                    <input type="text" id="searchbox" class="form-control name" placeholder="search">
                </div>
                <div class="col-md-2">
                    <button type="button" id="downloadExcel" class="btn btn-primary btn-md" data-toggle="tooltip" title="Download Excel">

                        <span><i class="fa fa-file-excel-o"></i></span>
                    </button>
                </div>
                <div class="col-md-2">
                    <button type="button" id="downloadPdf" class="btn btn-primary btn-md" data-toggle="tooltip" title="Download Pdf">
                        <span><i class="fa fa-file-pdf-o"></i> </span>
                    </button>
                </div>
            </div>
            <!--</div>
    <div class="downloadReport col-md-12" id="display_result" style="display:none">-->
            <table id="rtable" class="table">
                <col width="20">
                <col width="170">
                <col width="170">
                <col width="700">
                <col width="700">
                <col width="150">
                <col width="400">
                <col width="300">
                <col width="150">
                <thead>
                <tr>
                    <th class="text-center" th:text="#{s.no}">S.No.</th>
                    <th class="text-center" th:text="#{trackid}">Track Id</th>
                    <th class="text-center" th:text="#{labelcode}">Label Code</th>
                    <th class="text-center" th:text="#{sender.details}">Sender's Details</th>
                    <th class="text-center" th:text="#{recipient.details}">Recipient's Details</th>
                    <th class="text-center" th:text="#{parcel.contents}">Content</th>
                    <th class="text-center" th:text="#{created.on}">Created On</th>
                    <th class="text-center" th:text="#{services}">Services</th>
                    <th class="text-center" th:text="#{status}">Status</th>
                </tr>
                </thead>
                <tbody id="tbody">
                </tbody>
            </table>
        </div>
        <div id="no_data" style="display:none">
            <h3 class="tableTitle text-center">
				<span th:text="#{no.transactions.available}"> No
					Transactions Available </span><span>!!!</span>
            </h3>
        </div>
    </div>
</div>

<!-- footer -->
<th:block th:include="_footer"></th:block>
<!-- footer -->
</body>
<!-- /Print -->

<script>
    $(document).ready(function() {

        $("#reportForm").validate({

            rules: {
                fromdate: "required",
                todate: "required"
            },
            messages: {
                fromdate: "Please specify your date",
                todate: "Please specify your date"
            },
            highlight: function(element) {
                $(element).css('background', '#ffdddd');
            },
            unhighlight: function(element) {
                $(element).css('background', '#fff');
            },
        })

        // Check if body height is higher than window height :)
        if ($(document).height() > $(window).height()) {
            $("#foot").addClass("footer-top-margin");
        }

        var now = new Date();
        var day = ("0" + now.getDate()).slice(-2);
        var month = ("0" + (now.getMonth() + 1)).slice(-2);
        today = now.getFullYear()+"-"+(month)+"-"+(day) ;
        $("#fromdate").val(today);
        $("#todate").val(today);
    });
    $("#submitGetReport").on("click", function() {

        $('#rtable').DataTable().destroy();
        $('#tbody').empty();
        var data = $("#reportForm").serialize();

        if ($('#reportForm').valid() == true) {
            $.ajax({
                type: "get",
                url: "/parcel/listParcelReport?ajax=true&" + data,
                dataType: "json",
                cache: false,
                success: function(result) {
                    if(result.length===0){
                        $('.downloadReport').hide();
                        $('#no_data').show();
                    }else {
                        $('.downloadReport').show();
                        $('#no_data').hide();
                        $.each(result, function (i, item) {

                            var created_date = item.createdDate;
                            var time = new Date(created_date);

                            //format date
                            var userDate = item.createdDate.substr(0, 10);
                            var date = userDate.split("-");
                            var title_date = date[2] + "/" + date[1] + "/" + date[0];

                            if (item.status === "void") {
                                var $tr = $('<tr class="bg-danger">').append(
                                    $('<td>').text(i + 1),
                                    $('<td>').text(item.trackId),
                                    $('<td>').text(item.labelCode),
                                    $('<td>').text("Name :" + item.senderName + ", Mob. No.: " + item.senderMobileNumber + "," + item.senderAddress.addressLine1 + "," +
                                        (item.senderAddress.addressLine2 == "" ? "" : item.senderAddress.addressLine2 + ",") + (item.senderAddress.landmark == "" ? "" : item.senderAddress.landmark + ",") +
                                        item.senderAddress.subOffice + ", " + item.senderAddress.thana + ", " +
                                        item.senderAddress.district + ", " + item.senderAddress.division + ", " +
                                        item.senderAddress.zone + "-" + item.senderAddress.postalCode),
                                    $('<td>').text("Name :" + item.recipientName + ", Mob :" + item.recipientMobileNumber + "," + item.receiverAddress.addressLine1 + ", " + (item.receiverAddress.addressLine2 == "" ? "" : item.receiverAddress.addressLine2 + ",") +
                                        (item.receiverAddress.landmark == "" ? "" : item.receiverAddress.landmark + ",") + item.receiverAddress.subOffice + ", " + item.receiverAddress.thana + ", " +
                                        item.receiverAddress.district + ", " + item.receiverAddress.division + ", " + item.receiverAddress.zone + "-" + item.receiverAddress.postalCode),
                                    $('<td>').text(item.parcelContent),
                                    $('<td>').text(title_date + " " + time.toString().substring(16, 24)),
                                    $('<td>').text(item.invoiceBreakup.name),
                                    $('<td class="text-center">').text(item.status)
                                );
                                $('#tbody').append($tr);

                            } else {
                                var $tr = $('<tr>').append(
                                    $('<td>').text(i + 1),
                                    $('<td>').text(item.trackId),
                                    $('<td>').text(item.labelCode),
                                    $('<td>').text("Name :" + item.senderName + ", Mob. No.: " + item.senderMobileNumber + "," + item.senderAddress.addressLine1 + "," +
                                        (item.senderAddress.addressLine2 == "" ? "" : item.senderAddress.addressLine2 + ",") + (item.senderAddress.landmark == "" ? "" : item.senderAddress.landmark + ",") +
                                        item.senderAddress.subOffice + ", " + item.senderAddress.thana + ", " +
                                        item.senderAddress.district + ", " + item.senderAddress.division + ", " +
                                        item.senderAddress.zone + "-" + item.senderAddress.postalCode),
                                    $('<td>').text("Name :" + item.recipientName + ", Mob :" + item.recipientMobileNumber + "," + item.receiverAddress.addressLine1 + ", " + (item.receiverAddress.addressLine2 == "" ? "" : item.receiverAddress.addressLine2 + ",") +
                                        (item.receiverAddress.landmark == "" ? "" : item.receiverAddress.landmark + ",") + item.receiverAddress.subOffice + ", " + item.receiverAddress.thana + ", " +
                                        item.receiverAddress.district + ", " + item.receiverAddress.division + ", " + item.receiverAddress.zone + "-" + item.receiverAddress.postalCode),
                                    $('<td>').text(item.parcelContent),
                                    $('<td>').text(title_date + " " + time.toString().substring(16, 24)),
                                    $('<td>').text(item.invoiceBreakup.name),
                                    $('<td class="text-center">').text(item.status)
                                );
                                $('#tbody').append($tr);
                            }


                        });

                    }
                    /* pagination using datatable */
                    var dataTable = $('#rtable').dataTable({
                        "oLanguage": {
                            "sLengthMenu": "_MENU_"
                        },
                      //to disble page no for 1st page
						"fnDrawCallback": function(oSettings) {
					        if (oSettings._iDisplayLength > oSettings.fnRecordsDisplay()) {
					            $(oSettings.nTableWrapper).find('.dataTables_paginate').hide();
					        }
					        else
					        {
					            $(oSettings.nTableWrapper).find('.dataTables_paginate').show();
					        }
					    }
                    });
                    <!--custom search box-->
                    $("#searchbox").keyup(function() {
                        dataTable.fnFilter(this.value);
                    });

                    $(".dataTables_length").css('clear', 'none');
                    $(".dataTables_length").css('margin-top', '-40px');
                    $(".dataTables_length").css('margin-left', '30px');

                },
                error: function(response) {
                    console.log("something went wrong");
                }
            });
        } else {
            $('#reportForm').valid();
        }
    });

    <!--download in pdf-->
    $('#downloadPdf').on('click', function() {
        var data = $("#reportForm").serialize();
        $.ajax({
            url: "/parcel/downloadPdf?ajax=true&" + data,
            method: 'GET',
            xhrFields: {
                responseType: 'blob'
            },
            success: function(data) {

                //format date
                var date=new Date();
                var day=date.getDate();
                var month=date.getMonth()+1;
                var year=date.getFullYear();
                var h=date.getHours();
                var m=date.getMinutes();
                var s=date.getSeconds();
                var finalDate = day+"-"+month+"-"+year+"-"+h+"-"+m+"-"+s;

                var a = document.createElement('a');
                var url = window.URL.createObjectURL(data);
                a.href = url;
                a.download = 'ParcelReport-'+finalDate+'.pdf';
                document.body.append(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            }
        });
    });

    <!--download in excel-->
    $('#downloadExcel').on('click', function() {
        var data = $("#reportForm").serialize();
        $.ajax({
            url: "/parcel/downloadExcel?ajax=true&" + data,
            method: 'GET',
            xhrFields: {
                responseType: 'blob'
            },
            success: function(data) {

                //format date
                var date=new Date();
                var day=date.getDate();
                var month=date.getMonth()+1;
                var year=date.getFullYear();
                var h=date.getHours();
                var m=date.getMinutes();
                var s=date.getSeconds();
                var finalDate = day+"-"+month+"-"+year+"-"+h+"-"+m+"-"+s;

                var a = document.createElement('a');
                var url = window.URL.createObjectURL(data);
                a.href = url;
                a.download = 'ParcelReportExcel'+finalDate+'.xlsx';
                document.body.append(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            }
        });
    });
</script>