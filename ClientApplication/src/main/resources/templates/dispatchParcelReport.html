<!-- header -->
<th:block th:include="_header"></th:block>
<!-- /header -->

<div class="fixed-header container-sm-footer">
   <div class="site-wrapper market-US">
      <h1 class="text-center" th:text="#{daily.dispatch.report}">Daily Dispatch Parcel Report</h1>

      <form name="displayForwardDetailsForm" id="reportForm">
               <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
      <div class="col-md-12">
          <div id="AdminDiv">
            <!-- Input the bag id -->

              <div class="col-md-offset-2 col-md-3 spacer-bootom-sm">
               <div id="radiobtn">
                  <label th:text="#{select.user.type}">Select user type for parcel report</label>
                  <div class="newradioinput">
                     <input id="radioRMS" type="radio" name="selectDestination" value="RMS" checked th:text="#{register.RMS}">
                     <input id="radioPO" type="radio" style='margin-left: 80px' name="post" value="postoffice" th:text="#{post.office}">
                  </div>
                  <div id="radioErrorContainer" class="errorForm errorHeight">
                     <ul></ul>
                  </div>
               </div>
                </div>
               <div  class="">
                  <div id="rms">
                     <!-- <span> <label th:text="#{select.rms.and.type}">Select
                        RMS Type and RMS Name</label>
                        </span> -->
                         <div class="col-md-2" id="type">
                     <div class="form-group">
                        <label>
                        <span th:text="#{select.rms.type}">Select RMS Type</span>
                        </label>
                        <select class="form-control name" name="rmsTypeId" id="rmsTypeId">
                           <option value="" >select</option>
                           <option th:each="rmsType : ${T(com.constants.RmsType).values()}" th:value="${rmsType.rmsType}" th:id="${rmsType}"
                              th:text="${rmsType.rmsType}">
                           </option>


                        </select>
                        </div>
                     </div>

                         <div class="col-md-2" >
                        <div class="form-group">
                           <label>
                           <span th:text="#{select.rms.name}">Select RMS Name</span>
                           </label>
                           <select class="form-control name" name="rmsName" id="rmsName">
                              <option value="">select</option>
                              <!-- <option th:each="rmsValue : ${rmsList}" th:value="${rmsValue.id}" th:id="${rmsValue.id}"
                                 th:text="${rmsValue.rmsName}">
                              </option> -->
                           </select>
                        </div>
                     </div>


                  </div>
                  <div id="postoffice">
                     <div class="col-md-3">
                        <div class="form-group" id="po">
                           <label>
                           <span th:text="#{select.po}">Select PO</span>
                           </label>
                           
                        <input list="browsers" name="poName"  class="form-control name " id="poName" th:placeholder="#{pocode.soname}"/>
                        <datalist id="browsers">
                            <option  th:each="poValue : ${pOList}" th:value="${poValue.postalCode}" th:id="${poValue.postalCode}"
                                     th:text="${poValue.subOffice}">
                            </option>
                        </datalist>
                           
                           
                           
                        </div>
                     </div>
                  </div>
               </div>


          </div>
      </div>


      <div class="col-md-12">

            <div class="rmsDiv">
               <div class="col-md-offset-2 col-md-2 spacer-bootom-sm">
                  <div class="form-group">
                     <label th:text="#{from.date}">From Date</label>
                     <input name="fromdate" id="fromdate" class="form-control name" autocomplete="off" type="date" data-toggle="tooltip">
                  </div>
               </div>
               <div class="col-md-2">
                  <div class="form-group">
                     <label th:text="#{to.date}">To Date</label>
                     <input name="todate" id="todate" autocomplete="off" class="form-control name" type="date" data-toggle="tooltip">
                  </div>
               </div>
               <div class="col-md-2">
                  <div class="form-group">
                     <label th:text="#{parcel.status}">Parcel Status</label>
                     <select class="form-control name" name="bagStatus" id="bagStatus">
                        <option value="">select</option>
                        <option value="IN">Inward</option>
                        <option value="OUT">Outward</option>
                     </select>
                  </div>
               </div>
               <div class="col-md-4 spacer-top-md">
                  <div class="form-group ">
                     <button type="button" id="geReport" class="btn btn-primary col-md-6">
                     <span th:text="#{get.report}"> Get Report</span>
                     </button>
                  </div>
               </div>

            </div>
             </div>
             <div id="noDataFound" style="display:none" class="text-center" margin-bottom: 100px;>
         <div>
            <h3 class="tableTitle">
               <span th:text="#{no.transactions.available}"> No
               Transactions Available </span><span>!!!</span>
               <span id="user" th:if="${roleId!=0}"  th:text="${roleId}" style="display:none"></span>
               <span id="subOfficeName" th:if="${poName!=0}"  th:text="${poName}" style="display:none"></span>
               <span id="RMSname" th:if="${RMSname!=0}"  th:text="${RMSname}" style="display:none"></span>
               <span id="RMStype" th:if="${RMStype!=0}"  th:text="${RMStype}" style="display:none"></span>
            </h3>
         </div>
      </div>
         </form>

      <div class="col-md-12" id="viewParcelDetails" style="display:none">
         <div class="col-md-offset-10 col-md-2 pull-right" style="margin-right:85px; margin-bottom:-40px" >
            <input type="text" id="searchbox" class="form-control name" placeholder="search">
         </div>
         <table id="rtable" class="table table-striped">
            <thead>
               <tr>
                  <th >S.No.</th>
                  <th >Track Id</th>
                  <th>Bag Id</th>
                  <th id="pstatus">Parcel Status</th>
                  <!--  <th>LocationType</th>                -->
                  <!-- <th id="rmsName1">To RMS</th>
                  <th id="rmstype1">RMS Type</th>
                    <th id="rmsName2">from RMS</th>
                     <th id="rmstype2">from RMS Type</th>  
                  <th id="SubOffice">To Sub-Office</th>
                  <th id="PostalCode">Postal Code</th> -->
                  <th>Parcel Content</th>
                  <th>Weight (in gms)</th>
               </tr>
            </thead>
            <tbody id="tbody">
            </tbody>
            <tfoot id="tfootId" align="right">
               <tr>
                  <th></th>
                  <th></th>
                  <th></th>
                  <th></th>
                  <th></th>
                  <th></th>
                 <!--  <th></th>
                  <th></th>
                  <th></th>
                  <th></th> -->
               </tr>
            </tfoot>
         </table>
      </div>
   </div>
</div>


<!-- footer -->
<th:block th:include="_footer"></th:block>
<!-- footer -->
</body>
<!-- /Print -->

<script>
var dtable;
var rmsType = "-";
var rms = "-";
var currentPostalCode = "-";
var subOffice = "-";
var TClocationType = "";
var TClocationID = "";
var trackId;
var parcelContent;
var pStatus = "";
var actWt;
var bagId="";
var updateOffice="";
var u=$("#user").text();
var subOff=$("#subOfficeName").text();
var rmsNAME=$("#RMSname").text();
var rmsTYPE=$("#RMStype").text();
var today="";
var rmsText="";
$('#noDataFound').hide();

$(document).ready(function() {
	rmsText=$('#rmsName1').text();

	$("#reportForm").validate({

         rules: {
        	 rmsName: "required",
             poName: "required",
             bagStatus :"required",
             rmsTypeId:"required"
         },
         messages: {
        	 bagStatus: "Please select any status",
        	 poName: "Please select any suboffice",
        	 rmsName: "Please select any RMS name",
        	 rmsTypeId: "Please select any RMS type"
         },
         highlight: function (element) {
             $(element).css('background', '#ffdddd');
         },
         unhighlight: function (element) {
             $(element).css('background', '#fff');

         },
     })

	now = new Date();
	var day = ("0" + now.getDate()).slice(-2);
	var month = ("0" + (now.getMonth() + 1)).slice(-2);
	 today = now.getFullYear() + "-" + (month) + "-" + (day);
	$("#fromdate").val(today);
	$("#todate").val(today);

	$("#po").hide();

 if (u==3){

		$("#AdminDiv").hide();
		$('.rmsDiv').removeClass("col-md-6");
		$(".rmsDiv").addClass("col-md-12");
		//userData();
	}
	else if (u==4){

		$("#AdminDiv").hide();
		$('.rmsDiv').removeClass("col-md-6");
		$(".rmsDiv").addClass("col-md-12");
	}

});


 $('#rmsTypeId').on('change', function () {
	 var status = $(this).val();

	 $("#rmsName").empty();
	 var status = $(this).val();
     $.ajax({
         type: "GET",
         url: "/pbTracking/getRMSNameByRMSType",
         data: {
             rmsType: status
         },
         success: function (result) {
        	 if ($("#rmsTypeId").val() != "") {

             $.each(result,function(key, data){

				      var rmsList= "<option id=" + data.id + " value=" + data.id + ">" + data.rmsName + "</option>";
				      $("#rmsName").append(rmsList);

				    });
        	 }else{


			      $("#rmsName").append("<option>select</option>");
        		 $('#viewParcelDetails').hide();
        	 }

         },

     });

 });




$('#bagStatus').on('change', function () {
	var status = $(this).val();
	if ($("#bagStatus").val() != "") {
		$('#viewParcelDetails').hide();
		$('#noDataFound').hide();
	} else {
		$('#viewParcelDetails').hide();
		$('#noDataFound').hide();
	}
});

$('#poName').on('change', function () {
	var status = $(this).val();
	if ($("#poName").val() != "") {

		$('#viewParcelDetails').hide();
	} else {

		$('#viewParcelDetails').hide();
	}
});

$("input[name='selectDestination']").click(function(){
		$("#po").hide();
		$("#rms").show();
		$("#poName").val('');

		$("input[name='post']").prop('checked',false);
		//$("#rmsTypeId").append("<option>select</option>");
		$('#viewParcelDetails').hide();
});

$("input[name='post']").click(function(){

	$("input[name='selectDestination']").prop('checked',false);
		$("#rms").hide();
		$("#po").show();
		$("#rmsName").val('');
		$('#viewParcelDetails').hide();

});

$("#geReport").click(function() {
	$("#rtable").DataTable().destroy();
	$('#tbody').empty();

		if ($('#reportForm').valid() == true) {
			 /* if($('#bagStatus').val()=="IN"){
				 $('#rmsName1').text(' ');
				 $('#rmsName1').append("From RMS");

				 $('#SubOffice').text(' ');
				 $('#SubOffice').append("From Suboffice");
			}
			else if($('#bagStatus').val()=="OUT"){
				 $('#rmsName1').text(' ');
				 $('#rmsName1').append("To RMS");

				 $('#SubOffice').text(' ');
				 $('#SubOffice').append("To Suboffice");
			} */
			if($('input[name="post"]:checked').val() == "postoffice")
			{			userData()

			}

			else if($('input[name="selectDestination"]:checked').val() == "RMS")
				{
					userData()
				}

			else if (u==3){
				if ($("#bagStatus").val() != "") {
				userData()
				}
			}
			else if (u==4){
				if ($("#bagStatus").val() != "") {
				userData()
			  }
		    }
	}
});


	function userData(){
		var rmsName=$("#rmsName").val();
		$('#viewParcelDetails').hide();
		var poCode=$("#poName").val();

		var dateA=$("#fromdate").val();
		var dateB=$("#todate").val();
		var pStatus=$("#bagStatus").val();
		
		var nowDate = new Date();
		var day = ("0" + nowDate.getDate()).slice(-2);
		var month = ("0" + (nowDate.getMonth() + 1)).slice(-2);
		var today = nowDate.getFullYear() + "-" + (month) + "-" + (day);
		var fDate = $("#fromdate").val();
		var tDate = $("#todate").val();
		var str1 = fDate.toString();
		var res1 = str1.split("-");
		var fDate1 = res1[2] + "/" + res1[1] + "/" + res1[0];
		var str2 = tDate.toString();
		var res2 = str2.split("-");
		var tDate1 = res2[2] + "/" + res2[1] + "/" + res2[0];
		
		if ($("#bagStatus").val() != "") {
	$.ajax({
        type: "get",
        url: "/pbTracking/dailyDispatchReportAdmin?ajax=true&",
        dataType: "json",
        data: {
	   		rmsName: rmsName,
			poCode: poCode,
			fromdate:dateA,
			todate:dateB,
			parcelStatus:pStatus
   		},
        cache: false,
		success: function(result){
			
			
			if(jQuery.isEmptyObject(result)){
				$('#viewParcelDetails').hide();
				$('#noDataFound').show();
        	}
			else{
            	$('#noDataFound').hide();
			$('#viewParcelDetails').show();
			$.each(result, function(i,value) {
								var j = 0;
				if(i=="Tracking"){

					var sn=1;
					var item=result['Tracking'];
				
					$.each(item, function(i,value) {
						
						//trackId = value.objParcel.trackId;
						trackId = (value.objParcel == null ? "-" : value.objParcel.trackId);
						parcelContent = value.objParcel == null ? "-" : value.objParcel.parcelContent;
						pStatus = value.pStatus;
						TClocationType=value.locationType;
						TClocationID=value.locationId;
						
						bagId=value.bagId;
						//actWt = value.objParcel.actWt;
						actWt = value.objParcel== null ? 0 : value.objParcel.actWt;
						updateOffice=value.updatedBy.postalCode;

					if(TClocationType == "RMS")
						{
							var item=result['rms'];
							$.each(item, function(i,value) {
									if(TClocationID == value.id)
										{
										rms =  value.rmsName;
										rmsType=value.rmsType;
										
										}
							});

						}


					else if(TClocationType == "POST_OFFICE")
					{
							var masterData=result['master'];
							$.each(masterData, function(i,master) {
								if(TClocationID == master.postalCode)
									{
									currentPostalCode =  master.postalCode;
									subOffice = master.subOffice;
									}
							});
					}
					if(value.objParcel != null){
						
					var $tr = $('<tr>').append(
							$('<td>').text(sn),
					         $('<td>').text(trackId),
					         $('<td>').text(bagId),
					         $('<td>').text(pStatus),
	   			            /*  $('<td>').text(rms),	   			             
					    	 $('<td>').text(rmsType),
					    	 $('<td>').text(subOffice),
					    	 $('<td>').text(currentPostalCode), */
					    	 $('<td>').text(parcelContent),
					    	 $('<td>').text(actWt),

		    		         );
					}
					else{
						--sn;
					}
					 $('#tbody').append($tr);
					 ++sn;
					  currentPostalCode = "-";
					 subOffice = "-";
					 rmsType = "-";
					 rms = "-"; 
					 //poCode=$("#poName").val('');

					});

				
				}
					});

 		 dtable = $('#rtable').DataTable({
		    	"footerCallback": function ( row, data, start, end, display ) {
		            var api = this.api(), data;
		            // converting to interger to find total
		            var intVal = function ( i ) {
		                return typeof i === 'string' ?
		                    i.replace(/[\$,]/g, '')*1 :
		                    typeof i === 'number' ?
		                        i : 0;
		            };

		            // computing column Total of the complete result
		         var monTotal = api
		                .column( 0 )
		                .data()
		                .reduce( function (a, b) {
		                    return intVal(a) + intVal(b);
		                }, 0 );

			     var thuTotal = api
		                .column( 5 )
		                .data()
		                .reduce( function (a, b) {
		                    return intVal(a) + intVal(b);
		                }, 0 );

			      // Update footer by showing the total with the reference of the column index

		            $( api.column( 0 ).footer() ).html();
		            $( api.column( 4 ).footer() ).html('Total :');
		            $( api.column(5 ).footer() ).html(thuTotal);

		        },

             "paging": true,
             "dom": '<"top"lB>rt<"bottom"ip>',
             "oLanguage": {
                 "sLengthMenu": "_MENU_"
             },
           //to disble page no for 1st page
				"fnDrawCallback": function(oSettings) {
			        if (oSettings._iDisplayLength > oSettings.fnRecordsDisplay()) {
			            $(oSettings.nTableWrapper).find('.dataTables_paginate').hide();
			        }
			        else
			        {
			            $(oSettings.nTableWrapper).find('.dataTables_paginate').show();
			        }
			    },
             buttons: [
                 {
                     extend: 'pdfHtml5',
                     text: '<span class="fa fa-file-pdf-o"></span>',
                     title: 'Parcel Inward/Outward  Report   '+"\n"+( $('#user').text()==1 ? ($('input[name="selectDestination"]:checked').val() == "RMS" ? ($("#rmsTypeId :selected").text() + ' (' + $('#rmsName').text() + ') ' ) : ($('#'+$('#poName').val()).text() + '(' + $('#poName').val()+ ')')) : $('#user').text()==3 ? (subOff+"("+updateOffice+")") : (rmsNAME+"("+rmsTYPE+")"))+"\n" +((fDate==tDate) ? fDate1 : fDate1 + ' -to- ' + tDate1),
                     orientation: 'landscape',
                     pageSize: 'A4',
                     "charset": "utf-8",

                     footer: true,
                     exportOptions: {
                         modifier: { page: 'all', search: 'none' },
                     },
                     customize: function (doc) {
                         doc.content[1].layout = "Borders";
                         doc.content[1].margin = [0, 0, 0, 0]; //left, top, right, bottom

                         doc.defaultStyle.fontSize = 9;
	      	 				 doc.styles.tableHeader.fontSize = 9;
                         //auto set column width: equally divide between columns
                         doc.content[1].table.widths =
                             Array(doc.content[1].table.body[0].length + 1).join('*').split('');
                         //to align all columns in the center
                         doc.defaultStyle.alignment = 'center';
                         doc.styles.tableHeader.alignment = 'center';
                         var rowCount = doc.content[1].table.body.length;
                         for (i = 1; i < rowCount; i++) {
                             doc.content[1].table.body[i][1].alignment = 'left';
                         }

                         var nown = new Date();
                         doc['footer'] = (function (page, pages) {
                             return {
                                 columns: [
                                     {
                                         alignment: 'left',
                                         text: ['Created on: ', { text:nown.toString().substring(0,25) }]
                                     },
                                     {
                                         alignment: 'right',
                                         text: ['page ', { text: page.toString() }, ' of ', { text: pages.toString() }]
                                     }
                                 ],
                                 margin: 10
                             }
                         });
                     },
                 },
                 {
                     extend: 'excelHtml5',
                     text: '<span class="fa fa-file-excel-o"></span>',
                     title: 'Parcel Inward/Outward  Report   '+"\n"+( $('#user').text()==1 ? ($('input[name="selectDestination"]:checked').val() == "RMS" ? ($("#rmsTypeId :selected").text() + ' (' + $('#rmsName').text() + ') ' ) : ($('#'+$('#poName').val()).text() + '(' + $('#poName').val()+ ')')) : $('#user').text()==3 ? (subOff+"("+updateOffice+")") : (rmsNAME+"("+rmsTYPE+")"))+"\n" +((fDate==tDate) ? fDate1 : fDate1 + ' -to- ' + tDate1),
                    // messageTop:"Wise List",
                     orientation: 'landscape',
                     pageSize: 'A4',
                     footer: true,
                     exportOptions: {
                         modifier: { page: 'all', search: 'none' },
                     },
                 }
             ]
		 });
            $(".dataTables_length").css('clear', 'none');
 			$(".dataTables_length").css('margin-bottom', '-6px');
 			$(".dataTables_length").css('margin-left', '2px');

 			$(".rtable_length").css('clear', 'none');
 			$(".rtable_length").css('margin-bottom', '10px');
 			$(".rtable_length").css('margin-left', '30px');

 			$(".dt-buttons").css('clear', 'none');
 			$(".dt-buttons").css('margin-top', '-42px');
 			$(".dt-buttons").css('margin-right', '-7px');
 			$(".dt-buttons").css('font-size', '15px');

 			$('.downloadReport').show();
			}
			},
			error:function(response){
				console.log("something went wrong");
				$('#noDataFound').show();
				$('#viewParcelDetails').hide();
			}

		});
		}
	}

 	$("#searchbox").keyup(function() {
 		if ($(this).val().length > 0) {
			$('#tfootId').hide();
		}
		else{
		$('#tfootId').show();
		}
		   dtable.search(this.value).draw();

		 });

// Check if body height is higher than window height :)
		if ($(document).height() > $(window).height()) {
		      $("#foot").addClass("footer-top-margin");
		}
</script>