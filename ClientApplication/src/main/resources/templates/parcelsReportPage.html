<!-- header -->
<th:block th:include="_header"></th:block>
<!-- /header -->
<div class="fixed-header container-sm-footer create-label">
    <div class="site-wrapper market-US">
        <div class="container">
            <div class="col-md-12 spacer-top-sm text-center"> <b>
                <h1 th:text="#{parcels.mis}">Parcels Report (MIS)</h1>
            </b>
            </div>
            <form name="reportForm" id="reportForm" autocomplete="off">
            <div class="col-md-12 spacer-top-sm">
                    <div class="col-md-4 ">
                        <label th:text="#{services}">Services</label>
                        <div class="form-group services-dropdown">

                            <select class="form-control name hide" name="services" id="services" multiple>
                                <option th:each="postalService : ${postalServiceList}" th:value="${postalService.id}" th:id="${postalService.id}" th:text="${postalService.serviceName}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4 ">
                        <label th:text="#{sub.services}">Sub Services</label>
                        <div class="form-group services-dropdown">

                            <select class="form-control name hide" name="subservices" id="subservices" multiple>
                                <option th:each="subSubservice : ${subservicesList}" th:value="${subSubservice.id}" th:id="${subSubservice.id}" th:text="${subSubservice.serviceName}"></option>
                            </select>
                        </div>
                    </div>
                <div class="col-md-4">
                    <label th:text="#{status}">Status</label>
                    <select class="form-control name" name="status" id="status">
                        <option th:each="pStatusList : ${pStatusList}" th:value="${pStatusList}" th:text="${pStatusList.name}"></option>
                    </select>
                </div>
            </div>
                <div class="col-md-12 spacer-top-sm">

                    <div class="col-md-4">
                        <div class="form-group">
                            <label th:text="#{from.date}">From Date</label>
                            <input name="fromdate" id="fromdate" class="form-control name" autocomplete="off" type="date" data-toggle="tooltip">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <div class="form-group">
                                <label th:text="#{to.date}">To Date</label>
                                <input name="todate" id="todate" autocomplete="off" class="form-control name" type="date" data-toggle="tooltip">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 spacer-top-md">
                        <button type="button" class="btn btn-primary col-md-12" id="bag_parcels" th:text="#{get.report}">Get Reports</button>
                    </div>

            </div>
            </form>
            <div class="col-md-12 table-div" style="display:none">
                <div class="col-md-2 spacer-bottom-sm">
                    <input type="text" id="searchbox" class="form-control name" placeholder="search">
                </div>
                <table id="parcels-table" class="table table-striped text-center">
                    <col width="10">
                    <col width="150">
                    <col width="200">
                    <col width="150">
                    <col width="150">
                    <col width="150">
                    <thead>
                    <tr>
                        <th class="text-center" th:text="#{s.no}">S No</th>
                        <th class="text-center" th:text="#{trackid}">Track Id</th>
                        <th class="text-center col-md-2" th:text="#{payment.mod}">Payment Mode</th>
                        <th class="text-center col-md-2" th:text="#{tocollect}">To collect</th>
                        <th class="text-center col-md-2" th:text="#{parcel.contents}">Parcel Content</th>
                        <th class="text-center" th:text="#{status}">Status</th>
                        <th class="text-center" th:text="#{paid.amount}">Paid Amount</th>
                        <th class="text-center" th:text="#{parcel.weight}">Weight (gms)</th>
                        <th class="text-center" th:text="#{services}">Services</th>
                    </tr>
                    </thead>
                    <tbody id="parcels-body"></tbody>
                    <tfoot id="tfooter"></tfoot>
                </table>
            </div>
            <div id="no_data" style="display:none">
                <h3 class="tableTitle text-center">
								<span th:text="#{no.transactions.available}"> No
					Transactions Available </span>
                    <span>!!!</span>
                    <span id="poName" th:if="${poName!=0}"  th:text="${poName}" style="display:none"></span>
                    <span id="userPostalCode" th:if="${userPostalCode!=0}"  th:text="${userPostalCode}" style="display:none"></span>
                </h3>
            </div>
            <!-- pop-up modal -->
            <div id="service-select" class="modal fade" tabindex="-1" role="dialog" >
                <div class="modal-dialog modal-sm">
                    <div class="modal-content text-center">

                        <h3 class="select-parcels text-danger" th:text="#{select.services}">Please Select Services</h3>
                        <button type="button" class="btn btn-primary" data-dismiss="modal" th:text="#{okay}">Okay</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
	var dataTable;
	var pmode;
	var prepaidAmt;
	var totalPrepaidAmt = 0;
	var amt_total = 0;
	var totalWeight = 0;
	var serviceCode;
	$(document).ready(function(){

	$("#reportForm").validate({

	            rules: {
	                services: "required",
	                status: "required"
	            },
	            messages: {
	                services: "Please Select your Services",
	                status: "Please Select your status"
	            },
	            highlight: function(element) {
	                $(element).css('background', '#ffdddd');
	            },
	            unhighlight: function(element) {
	                $(element).css('background', '#fff');
	            },
	        })

	        // Check if body height is higher than window height :)
	        if ($(document).height() > $(window).height()) {
	            $("#foot").addClass("footer-top-margin");
	        }


	 var now = new Date();
	        var day = ("0" + now.getDate()).slice(-2);
	        var month = ("0" + (now.getMonth() + 1)).slice(-2);
	        today = now.getFullYear()+"-"+(month)+"-"+(day) ;
	        $("#fromdate").val(today);
	        $("#todate").val(today);



	});

	$('#bag_parcels').on('click',function(){
	totalWeight=0;
    var data = $("#reportForm").serialize();

    if($('#subservices').val().length == 0){
        data = data+"&subservices="+$('#subservices').val();
    }

	if($('#services').val().length != 0){
	$('#parcels-table').DataTable().destroy();

	$('#parcels-table #parcels-body').empty();


	if ($('#reportForm').valid() == true) {
	$.ajax({
	        type: "get",
			url: "/po/getParcelsReportOnMis?"+data,
			dataType: "json",
			cache: false,
			success: function (result) {

              var data;

             for(var item in result)
             {
                    if(item=="reportmisdata"){
                          data=result[item];
                    }else{
                    serviceCode=result[item];
                    }

             }
			if(data.length === 0){
			     $('.table-div').hide();
			     $('#no_data').show();
			}else{
			 $('#no_data').hide();
			 $('.table-div').show();
	                var $tr;

	                $.each(data, function (i, item) {

	                            var pmode;
	                            var prepaidAmt;
	                            if(item.toPay)
									pmode="To Pay";
								else if(item.cod)
									pmode = "COD";
								else
									pmode="Prepaid";

								var amt;

								if(pmode == "To Pay")
									amt = item.parcelDeclerationValue;
								else if(pmode == "COD")
									amt = item.invoiceBreakup.payableAmnt;
								else
									amt = item.invoiceBreakup.payableAmnt;


	                     $tr = $('<tr>').append(
	                    $('<td>').text(i+1),
						$('<td>').text(item.trackId),
						$('<td>').text(pmode),
						$('<td>').text(pmode == 'COD' || pmode == 'To Pay' ? amt+" Ts":"-"),

						$('<td>').text(item.parcelContent),
						$('<td>').text(item.pStatus.replace(/_/g, " ")),
						$('<td>').text(pmode != 'COD' && pmode != 'To Pay' ? amt+" Ts":"-"),
						$('<td>').text(item.actWt),
						$('<td>').text(item.serviceCode)
						);

	                    totalWeight = parseInt(totalWeight) + parseInt(item.actWt);
	                    if(pmode == 'COD' || pmode == 'To Pay'){
	                       amt_total = parseInt(amt_total) + parseInt(amt);

	                    }
	                    if(pmode != 'COD' && pmode != 'To Pay'){
	                       totalPrepaidAmt = parseInt(totalPrepaidAmt) + parseInt(amt);

	                    }

					$('#parcels-body').append($tr);

			});
	                $('#tfooter tr:last').remove();

	                $('#tfooter').append([
							  	         "<tr>",
							  	            "<td class='text-center'></td>",
							               "<td class='text-center'></td>",
									       "<td class='text-center'>"+"Total:"+"</td>",
							               "<td class='text-center'>"+amt_total+" Ts</td>",
							               "<td class='text-center'></td>",
							               "<td class='text-center'></td>",
							               "<td class='text-center'>"+totalPrepaidAmt+" Ts</td>",
							               "<td class='text-center bg'>"+totalWeight+" gms</td>",
							               "<td class='text-center col-md-1'></td>",
							            '</tr>'
								].join(''));
								amt_total = 0 ;
								totalPrepaidAmt = 0;


	       dataTable = $('#parcels-table').dataTable({
	            "oLanguage": {
	                            "sLengthMenu": "_MENU_"
	                        },
	            dom: 'Blfrtip',
                buttons: [

			     	                       { extend: 'pdfHtml5',
				 	      	                    	text: '<span class="fa fa-file-pdf-o"></span>',
	                                                title: 'Parcel Report MIS'+"\n"+$('#poName').text() +"("+ $('#userPostalCode').text()+")"+"-"+"("+$("#fromdate").val()+" - "+$("#todate").val()+")"+"\n"+
				 	      	                    	"Selected Services :"+serviceCode+"   Status :"+$('#status').val()+"",

				 	      	                    	orientation: 'portrait',
				 	      	                    	pageSize: 'A4',
				 	      	                    	"charset": "utf-8",
				 	      	                    	footer: true,
				 	      	                    	exportOptions: {
					 	      	                                modifier: { page: 'all', search: 'none' } ,
					 	      	                    	},
					 	      	 					customize: function (doc) {
					 	      	 					   doc.content[1].layout = "Borders";
					 	      	 				       doc.content[1].margin = [ 0, 0, 0, 0 ]; //left, top, right, bottom

						 	      	                   	 doc.defaultStyle.fontSize = 9;
							 	      	 				 doc.styles.tableHeader.fontSize = 9;

					 	      	 					},
				 	      	                       },
				 	      	                       {
				 	         	                    	extend: 'excelHtml5',
				 	         	                        text: '<span class="fa fa-file-excel-o"></span>',
                                                        title: 'Parcel Report MIS'+"\n"+$('#poName').text() +"("+ $('#userPostalCode').text()+")"+"-"+"("+$("#fromdate").val()+" - "+$("#todate").val()+")"+"\n"+
				 	      	                    	    "Selected Services :"+serviceCode+"   Status :"+$('#status').val()+"",				 	         	                      	orientation: 'landscape',
					 	      	                    	pageSize: 'A4',
					 	      	                    	footer: true,
					 	      	                    	exportOptions: {
						 	      	                    	   modifier: { page: 'all', search: 'none' } ,
						 	      	                    	},

				 	         	                   }
				 	     					]

	        });
	         $("#searchbox").keyup(function() {
	                        if ($(this).val().length > 0) {
			                    $('#tfooter').hide();
		                    }
		                    else{
		                        $('#tfooter').show();
		                     }
	                        dataTable.fnFilter(this.value);
	                    });

	                    $(".dataTables_length").css('clear', 'none');

	                    $(".dataTables_length").css('margin-left', '30px');


			}

			}



	});


	 }
	 }else{
	    $('#service-select').modal('show');
	 }
	});
</script>
<script type="text/javascript">
	$(document).ready(function() {
	    $('#services').multiselect({
	      includeSelectAllOption: true,
	      selectAllValue: 'multiselect-all',
	      numberDisplayed:1,
	      buttonWidth:338
	    });

	     $("#services").multiselect('selectAll', false);
	     $("#services").multiselect('rebuild');

	    $('#subservices').multiselect({
	      includeSelectAllOption: true,
	      selectAllValue: 'multiselect-all',
	      numberDisplayed:1,
	      buttonWidth:338
	    });

	    $("#subservices").multiselect('selectAll', false);
	    $("#subservices").multiselect('rebuild');

	 });


	//onchange
	  $('#services').on('change',function(){

    $('#subservices').empty();
   var parentServices = $('#services').val();
       if(parentServices.length != 0){
	   parentServices.forEach(function(entry) {
	        $.ajax({
	        type: "get",
			url: "/parcel/getSubService?serviceId="+entry,
			dataType: "json",
			cache: false,
			success: function (result) {

			  $.each(result, function (i, item) {

			    $('#subservices').append('<option value="'+item.id+'">'+item.serviceName+'</option>');
			  });

			  $('#subservices').multiselect({
	                includeSelectAllOption: true,
	                selectAllValue: 'multiselect-all',
	                numberDisplayed:1,
	                });
	                 $("#subservices").multiselect('selectAll', false);
	                 $("#subservices").multiselect('rebuild');

			}
			});
	    });
        }
  });
</script>
<th:block th:include="_footer"></th:block>
</body>